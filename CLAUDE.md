# Portfolio Tracker — Claude Instructions

## Project Overview

Investment portfolio tracker CLI for managing holdings, transactions, cash balance, statistics, and rebalancing. Designed for a user trading on **Trade Republic** with **German tax residency**. Currently tracking a Revolut Robo-Advisor portfolio being migrated to Trade Republic.

## Tech Stack

- **Python 3.10+** with **Typer** CLI framework
- **SQLite** database (stored at project root: `portfolio.db`)
- **yfinance** for stock/ETF/bond prices (European ETFs need `.DE` suffix)
- **Rich** for terminal output formatting
- No external frontend dependencies — dashboard is vanilla HTML/JS/SVG

## Project Structure

```
src/portfolio_tracker/
├── cli/
│   ├── main.py                  # Typer app + command group registration
│   └── commands/
│       ├── cash.py              # pt cash balance|history|add
│       ├── dashboard.py         # pt dashboard open (web UI)
│       ├── holdings.py          # pt holdings add|list|remove
│       ├── portfolio.py         # pt portfolio create|list|show|delete
│       ├── prices.py            # pt prices fetch|history
│       ├── rebalance.py         # pt rebalance target|check|suggest|execute
│       ├── stats.py             # pt stats summary|allocation
│       └── transactions.py      # pt tx buy|sell|list
├── core/
│   ├── models.py                # Dataclasses: Portfolio, Holding, Transaction, CashTransaction, etc.
│   ├── calculator.py            # PortfolioCalculator (values, P&L, tax, allocation)
│   ├── rebalancer.py            # Rebalancer (deviation check, trade suggestions)
│   └── exceptions.py
├── data/
│   ├── database.py              # SQLite schema + connection (get_db, _find_project_root)
│   └── repositories/
│       ├── portfolios_repo.py
│       ├── holdings_repo.py
│       ├── transactions_repo.py
│       ├── prices_repo.py
│       ├── targets_repo.py
│       └── cash_repo.py         # Cash balance tracking
└── external/
    └── price_fetcher.py         # yfinance with TICKER_OVERRIDES + exchange suffix fallback

scripts/
├── import_revolut_csv.py        # Full Revolut CSV import (holdings + transactions + cash)
data/
├── revolut_transactions.csv     # Source CSV from Revolut
└── revolut_pnl.csv              # Revolut P&L export
```

## Database

SQLite at project root (`portfolio.db`), checked into git as backup.

### Tables
- `portfolios` — name, description
- `holdings` — per-portfolio, keyed by ISIN, with ticker for yfinance
- `transactions` — buy/sell/dividend per holding
- `cash_transactions` — portfolio-level cash flows (top_up, withdrawal, fee, dividend, buy, sell)
- `price_history` — historical prices per holding
- `target_allocations` — per-portfolio target % by asset type or ISIN

### DB Path Resolution
`_find_project_root()` walks up from `database.py` looking for `pyproject.toml`. The DB lives next to it. This makes it work correctly from venv, scripts, or any subdirectory.

## Key Design Decisions

- **Repository pattern**: Each table has its own repo class in `data/repositories/`
- **Decimal everywhere**: Financial calculations use `Decimal`, not `float`
- **EUR-centric**: All prices and values in EUR
- **German tax model**: Abgeltungssteuer (25%) + Soli (5.5%), Freistellungsauftrag configured via `config.json` (default €1,000 single / €2,000 joint)
- **Asset types**: stock, etf, crypto, bond (enum `AssetType`)
- **Cash is first-class**: Every buy/sell/dividend/fee creates a `cash_transactions` record. Cash balance = SUM(amount) from cash_transactions for the portfolio.
- **ISINs as primary identifiers**: Trade Republic standard. Tickers are secondary, used only for yfinance lookups.
- **Dashboard**: Single-file vanilla HTML/JS with SVG donut charts. No React/CDN — everything inline. Generated by `dashboard.py` and opened in browser via `tempfile`.

## European ETF Price Fetching

yfinance requires exchange suffixes for European ETFs. The `price_fetcher.py` handles this:

1. **TICKER_OVERRIDES** dict maps known tickers to Yahoo symbols (e.g., `IS3Q` → `IS3Q.DE`)
2. If not in overrides, tries ticker as-is
3. Falls back to trying `.DE`, `.L`, `.AS`, `.PA`, `.MI` suffixes
4. Full error handling — never crashes on bad tickers

Current overrides include all 8 Revolut ETFs + 4 Portfolio A ETFs (VWCE, VVSM, HEAL, VAGF).

## Cash Balance System

Cash transactions are stored in `cash_transactions` table with types:
- `top_up` — money deposited (positive)
- `withdrawal` — money withdrawn (negative)
- `buy` — cash spent on purchases (negative)
- `sell` — cash received from sales (positive)
- `dividend` — cash received from dividends (positive)
- `fee` — management fees (negative)

Balance = `SUM(amount)` — positive means cash available, negative means overdrawn.

Cash is displayed in: `pt portfolio show`, `pt stats summary`, `pt holdings list` (footer), `pt rebalance suggest` (available/remaining), `pt tx buy/sell` (after-trade balance), and the web dashboard.

When adding a buy/sell transaction via `pt tx buy|sell`, the corresponding cash_transaction is created automatically. Same for `pt rebalance execute`.

## CLI Command Reference

```bash
pt portfolio create|list|show|delete    # Portfolio CRUD (show includes cash + total value)
pt holdings add|list|remove             # Holdings management (list shows totals + cash footer)
pt tx buy|sell|list                     # Record transactions (auto-updates cash, shows balance after)
pt prices fetch|history                 # Fetch prices via yfinance
pt stats summary|allocation             # Portfolio stats + German tax calc (summary includes cash)
pt rebalance target|check|suggest|execute  # Rebalancing (suggest shows cash impact, execute records cash)
pt cash balance|history|add             # Cash balance management
pt dashboard open [--output FILE]       # Open web dashboard in browser
```

## Running

```bash
pip install -e .
pt --help
```

## Import

```bash
# Place CSVs in data/ directory, then:
python scripts/import_revolut_csv.py
```

The import script creates: portfolio + holdings + transactions (buy/dividend) + cash_transactions (top_up/buy/dividend/fee). It's not idempotent — running twice will create duplicates.

## Conventions

- Language: code and comments in English, user communication in Russian
- Commit messages in English
- All CLI output uses Rich formatting
- Prices displayed to 4 decimal places, values to 2
- Holdings sorted by value descending in most views
- German tax terms in dashboard have English translations in parentheses

## Target Portfolio A (Trade Republic)

Canonical allocation — updated 2026-02-24. Not yet funded (pending Revolut liquidation).

| Ticker | ISIN           | Weight | Threshold | TFS  |
|--------|----------------|-------:|----------:|------|
| VWCE   | IE00BK5BQT80   |    70% |        5% | 30%  |
| VVSM   | IE00BMC38736   |    15% |        3% | 30%  |
| HEAL   | IE00BYZK4776   |    10% |        3% | 30%  |
| VAGF   | IE00BG47KH54   |     5% |        3% | 0%   |

All funds are accumulating. Strategy: core (VWCE) + semiconductor satellite (VVSM) + healthcare (HEAL) + bond buffer (VAGF). XAIX was considered and dropped — overlaps with VWCE tech + VVSM.

Stored in `target_allocations` table for portfolio ID 1, keyed by ISIN. See `AGENTS.md` for full rationale and SQL to update.

## Future Plans

See `PLANS.md` for detailed roadmap. Key priorities:
1. Trade Republic CSV import (`scripts/import_tr.py`)
2. Vorabpauschale calculator for accumulating ETFs
3. Migration workflow (Revolut → TR)
4. Performance history + time-weighted return
5. Sparplan (DCA) tracking
